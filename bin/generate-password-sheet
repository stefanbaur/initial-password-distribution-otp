#!/bin/bash

CONFIGFILE="../etc/initpass.conf"

# change to our working directory, to make relative paths work
cd $(dirname $0)

# load configuration or error out
if ! [ -s "$CONFIGFILE" ] ; then
	echo "Config file '$CONFIGFILE' not found. Exiting."
	exit 1
else
	source "$CONFIGFILE"
fi

# check that required variables are non-empty
if [ -z "$1" ] ; then
	echo "No account name(s) provided. Exiting."
	exit 1
fi

# check for less common executables required by this script
if ! which soffice >/dev/null; then
	echo "No 'soffice' executable found. Exiting."
	exit 1
fi

if ! which pwgen >/dev/null; then
	echo "No 'pwgen' executable found. Exiting."
	exit 1
fi

# treat each command line parameter as account name
for ACCOUNTNAME in $@ ; do
	# check if we're dealing with an E-Mail address
	if ! echo "$ACCOUNTNAME" | grep -q "@" ; then
		echo "Warning: No '@' sign in '$ACCOUNTNAME' - this is not a vaild E-Mail address. You will not be able to use the 'mail-password-sheet' command."
	fi

	# let's get to work ...
	echo -n "Generating sheet for '$ACCOUNTNAME' ..."

	# generate random OTP sheet as CSV
	# with the "Liberation Mono" font at 16pt and paper size "DIN A4", we can fit columns from A to W (thus 23) and 33 lines on one sheet.
	(echo '"";A;B;C;D;E;F;G;H;I;J;K;L;M;N;O;P;Q;R;S;T;U;V;W;'; pwgen $PWGEN_PARAMS -1 23 33 | sed -e 's/./&;/g;s/^./;&/;' | grep -n '^.' | tr -d ':' | sed -e 's/^\([0-9]\);/0\1;/') > "${OTPDIR}/data/${ACCOUNTNAME}.csv"

	# create FODS from CSV (FODS is a simple XML file containing all the data usually found in a ODS file - which is a ZIP file with subdirectories, actually)
	soffice --headless --convert-to fods --infilter=CSV:59,34,UTF8 --outdir "${OTPDIR}/data" "${OTPDIR}/data/${ACCOUNTNAME}.csv" >/dev/null 2>&1

	# grab our preformatted FODS header file and merge it with the data part of the ACCOUNTNAME FODS file.
	echo -e "$(sed -e 's#HEADER_GOES_HERE#'"$ACCOUNTNAME"'#g' ${OTPDIR}/etc/otp-formatted-header.fods)\n$(grep '^      <text:p>W</text:p>' -A100000 "${OTPDIR}/data/${ACCOUNTNAME}.fods" )" > "${OTPDIR}/data/${ACCOUNTNAME}.fods"

	# now turn the merged FODS into a PDF
	soffice --headless --convert-to pdf --outdir "${OTPDIR}/data" "${OTPDIR}/data/${ACCOUNTNAME}.fods" >/dev/null 2>&1

	# report success
	echo " done."
done
