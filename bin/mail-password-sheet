#!/bin/bash

CONFIGFILE="../etc/initpass.conf"

# change to our working directory, to make relative paths work
cd $(dirname $0)

# load configuration or error out
if ! [ -s "$CONFIGFILE" ] ; then
	echo "Config file '$CONFIGFILE' not found. Exiting."
	exit 1
else
	source "$CONFIGFILE"
fi

# check that required variables are non-empty
if [ -z "$MAILSUBJECT" ] ; then
	echo "No mail subject set in '$CONFIGFILE'. Exiting."
	exit 1
fi

if [ -z "$1" ] ; then
	echo "No password sheet file name(s) provided. Exiting."
	exit 1
fi

# check for less common executables required by this script
if ! which mpack >/dev/null; then
	echo "No 'mpack' executable found. Exiting."
	exit 1
fi

# treat each command line parameter as file name
for FULLFILEPATH in $@ ; do
	FILE=$(basename "$FULLFILEPATH")
	MAILADDRESS=${FILE%.pdf}
	# check if we're dealing with an E-Mail address
	if ! echo "$MAILADDRESS" | grep -q "@" ; then
		echo "No '@' sign in '$MAILADDRESS' - this is not a vaild E-Mail address. Skipping ..."
	else
		# do we have a valid file name/path?
		if [ "$FILE" != "$FULLFILEPATH" ] ; then
			echo "Warning: File '$FILE' had extra path information."
			echo "Removing specified path and replacing it with '${OTPDIR}/data'."
		fi
		# skip sending an E-Mail if the file doesn't exist
		# small hack: we use MAILADDRESS and add .pdf again, instead of using FILE
		if ! [ -s "${OTPDIR}/data/${MAILADDRESS}.pdf" ] ; then
			echo "File '${OTPDIR}/data/${MAILADDRESS}.pdf' not found. Skipping ..."
		else
			mpack -s "$MAILSUBJECT" "${OTPDIR}/data/${MAILADDRESS}.pdf" "$MAILADDRESS"
		fi
	fi
done
