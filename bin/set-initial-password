#!/bin/bash

CONFIGFILE="../etc/initpass.conf"

# change to our working directory, to make relative paths work
cd $(dirname $0)

# load configuration or error out
if ! [ -s "$CONFIGFILE" ] ; then
	echo "Config file '$CONFIGFILE' not found. Exiting."
	exit 1
else
	source "$CONFIGFILE"
fi

# check for less common executables required by this script
if ! which seq >/dev/null; then
	echo "No 'seq' executable found. Exiting."
	exit 1
fi

if ! which shuf >/dev/null; then
	echo "No 'shuf' executable found. Exiting."
	exit 1
fi

# treat each command line parameter as account name
for ACCOUNTNAME in $@ ; do
	# remove trailing ".csv" in case list of account names came from a directory listing
	ACCOUNTNAME=${ACCOUNTNAME%.csv}
	if ! [ -s "${OTPDIR}/data/${ACCOUNTNAME}.csv" ] ; then
		echo "File '${OTPDIR}/data/${ACCOUNTNAME}.csv' not found. Skipping ..."
	else
		# with the "Liberation Mono" font at 16pt and paper size "DIN A4", we can fit columns from A to W (thus 23) and 33 lines on one sheet.
		# generate a random number between 1 and (23 minus password length) for our columns
		COLUMNUMBER=$(seq 1 $((23-PWLENGTH)) | shuf -n 1)

		# calculate starting and ending columns (numeric) from the random number
		COLSTARTNUM=$((COLUMNUMBER+1))
		COLENDNUM=$((COLUMNUMBER+PWLENGTH))

		# turn the column numbers into letters
		COLSTARTLETTER=$(echo -e "\x$(printf "%x" $((COLUMNUMBER+64)))")
		COLENDLETTER=$(echo -e "\x$(printf "%x" $((COLUMNUMBER+64+PWLENGTH-1)))")

		# generate a random number between 1 and 33 for our row
		ROWNUM=$(seq 1 33 | shuf -n 1)
		ROWSTART=$((ROWNUM-1))

		# output line number, starting, and ending columns
		echo "account name: $ACCOUNTNAME"
		echo "line number: $ROWSTART"
		echo "starting column: $COLSTARTLETTER"
		echo "ending column: $COLENDLETTER"
		# only for debugging
		#echo "internal numbering: $ROWNUM $COLSTARTNUM $COLENDNUM"

		# retrieve the initial password
		INITIALPASS=$(head -n $ROWNUM "${OTPDIR}/data/${ACCOUNTNAME}.csv" | tail -n 1 | \
		cut -d ';' -f $COLSTARTNUM-$COLENDNUM | tr -d ';')

		# only for debugging
		#echo "initial password: '$INITIALPASS'"
		
		# execute update password command
		eval $(echo "$UPDATE_PASSWORD" | sed -e "s#OTPUSER#$ACCOUNTNAME#g" -e "s#OTPPASS#$INITIALPASS#g")
	fi
done
