#!/bin/bash

CONFIGFILE="../etc/initpass.conf"

# change to our working directory, to make relative paths work
cd $(dirname $0)

# load configuration or error out
if ! [ -s "$CONFIGFILE" ] ; then
	echo "Config file '$CONFIGFILE' not found. Exiting."
	exit 1
else
	source "$CONFIGFILE"
fi
# check that required variables are non-empty
if [ -z "$PRINTERNAME" ] ; then
	echo "No printer name set in '$CONFIGFILE'. Exiting."
	exit 1
fi

if [ -z "$1" ] ; then
	echo "No password sheet file name(s) provided. Exiting."
	exit 1
fi

# check for less common executables required by this script
if ! which soffice >/dev/null; then
	echo "No 'soffice' executable found. Exiting."
	exit 1
fi

# treat each command line parameter as file name
for FULLFILEPATH in $@ ; do
	FILE=$(basename "$FULLFILEPATH")
	# do we have a valid file name/path?
	if [ "$FILE" != "$FULLFILEPATH" ] ; then
			echo "Warning: File '$FILE' had extra path information."
			echo "Removing specified path and replacing it with '$OTPDIR/data'."
	fi
	FILE=${FILE%.fods}
	# skip printing the sheet if the file doesn't exist
	if ! [ -s "${OTPDIR}/data/${FILE}.fods" ] ; then
		echo "File '${OTPDIR}/data/${FILE}.fods' not found. Skipping ..."
	else
		soffice --headless --pt "$PRINTERNAME" "${OTPDIR}/data/${FILE}.fods" >/dev/null 2>&1
	fi
done
